##### 1. 高可用集群简介
###### 1.1 什么是高可用集群
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;高可用集群(High Availability Cluster，简称HA Cluster)，是指以减少服务中断时间为目的的服务器集群技术。它通过保护用户的业务程序对外不间断提供服务，把软件、硬件以及人为造成的故障对业务的影响降低到最小程度。
###### 1.2 高可用集群的衡量标准
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通常用平均无故障时间MTTF(mean time to failure)来衡量系统可靠性，用平均故障维修时间MTTR(mean time to restoration)来度量系统的可维护性，于是**可用性**被定义为：
$$HA=\frac{MTTF}{MTTF+MTTR}×\%$$

###### 1.3 自动侦测
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自动侦测阶段由主机上的软件通过冗余侦测线，经由复杂的监听程序，逻辑判断来相互侦测对方运行的情况。常用的方法是：**`集群各节点间通过心跳信息判断节点是否出现故障。`** 自动侦测在高可用集群中是非常重要的，是所有高可用集群必备的功能。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，自动侦测有一个缺点，就是 **脑裂**。在HA系统中，当联系2个节点的心跳线断开时，本来是一整体、动作协调的HA系统，就分裂成为2个独立的个体。由于相互失去联系，都以为是对方出故障了。两个节点便争抢共享资源、争抢启动应用服务，就会发生共享资源被瓜分、两边服务都起不来，或者两边服务都起来了。**`同时读写共享存储，就会导致数据损坏。`**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般来说脑裂的发生主要有以下原因：高可用服务器之间心跳线链路发生故障，导致无法正常通信；心跳线坏了，包括断了和老化等；因网卡和相关驱动坏了，ip配置冲突问题；心跳线之间连接的设备故障(网卡和交换机)；仲裁的机器出现问题(采用仲裁的方案)；高可用服务器上开启了iptables防火墙阻挡了心跳消息的传输；高可用服务器上细条网卡地址等信息配置错误，导致发送心跳失败；其它配置不当，如心跳方式不同，心跳广插冲突、软件bug等。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;脑裂问题的常见解决方案：① **`添加冗余心跳线`**，例如双线条线; ② 启用磁盘锁。**`正在服务的一方只有在发现心跳线全部断开时才启用磁盘锁，平时不上锁`**。服务器在使用磁盘的时候，把表锁起来进行写操作，其它只能读不能写，这样就保证数据唯一了。③ **`设置仲裁机制`**。找一台机器作为仲裁机，例如设置参考IP，当心跳完全断开时，2个节点都各自ping一下参考IP，不同则表明断点就在本端。不仅有心跳，而且还有对外服务的本端网络链路断了，即使启动或者继续应用服务也没有用，那就主动放弃竞争，让能够ping通的一端去起服务。更保险一些的是，ping不通参考IP的一方自我重启，以彻底释放有可能还占用着的那些共享资源。
###### 1.4 自动切换与故障转移
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自动切换阶段是:**`某一主机如果确认对方故障，正常的主机除了继续进行原来的任务，还将依据各种容错备援模式接管预定设置的备援作业程序，并进行后续的作业和服务。`** 简单来说，当系统 A (主机)无法为客户服务时，能够自动切换，使系统B能够顶上继续Wie客户提供服务，且客户无法察觉为它提供服务的对象已经更换。通过判断节点故障后，将高可用集群资源从该不具备法定票数的集群节点转移到故障转移域(Failover Doman，可以接受故障转移的节点)。
###### 1.5 其他高可用方案
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其它高可用方案有heartbeat、pacemaker、piranha(web页面)。